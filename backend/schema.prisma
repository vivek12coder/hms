// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(PATIENT)
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  patient Patient?
  doctor  Doctor?

  @@map("users")
}

model Patient {
  id               String    @id @default(cuid())
  userId           String    @unique @map("user_id")
  dateOfBirth      DateTime? @map("date_of_birth")
  gender           Gender?
  phone            String?
  address          String?
  emergencyContact Json?     @map("emergency_contact")
  medicalHistory   Json?     @map("medical_history")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  billings     Billing[]

  @@map("patients")
}

model Doctor {
  id             String    @id @default(cuid())
  userId         String    @unique @map("user_id")
  specialization String
  licenseNumber  String    @unique @map("license_number")
  availability   Json?     // Store doctor's weekly schedule
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("doctors")
}

model Billing {
  id            String        @id @default(cuid())
  patientId     String        @map("patient_id")
  amount        Float
  description   String
  status        BillingStatus @default(PENDING)
  issueDate     DateTime      @map("issue_date")
  dueDate       DateTime      @map("due_date")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([patientId])
  @@index([status])
  @@index([dueDate])
  @@map("billing")
}

// Enums
enum Role {
  ADMIN
  DOCTOR
  PATIENT
  RECEPTIONIST
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BillingStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum AuditOutcome {
  SUCCESS
  FAILURE
  WARNING
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Audit Log for HIPAA compliance
model AuditLog {
  id         String      @id @default(cuid())
  userId     String      @map("user_id")
  userRole   String      @map("user_role")
  action     String
  resource   String
  resourceId String?     @map("resource_id")
  patientId  String?     @map("patient_id")
  details    String?     // JSON string of additional details
  ipAddress  String      @map("ip_address")
  userAgent  String      @map("user_agent")
  outcome    AuditOutcome @default(SUCCESS)
  riskLevel  RiskLevel   @map("risk_level") @default(LOW)
  reason     String?
  hashChain  String      @map("hash_chain") // For tamper-proof audit trail
  createdAt  DateTime    @default(now()) @map("created_at")

  // Indexes for performance and compliance queries
  @@index([userId])
  @@index([patientId])
  @@index([action])
  @@index([createdAt])
  @@index([riskLevel])
  @@map("audit_logs")
}